{% extends "aid/base.html" %}
{% load static %}

{% block title %}Edit Request - RequestHub{% endblock %}

{% block content %}
<main class="py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <div class="mb-6">
            <nav class="flex mb-8 text-sm" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'aid:home' %}" class="text-gray-700 hover:text-purple-600 transition-colors">Home</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mx-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <a href="{% url 'aid:my_requests' %}" class="text-gray-700 hover:text-purple-600 transition-colors">My Requests</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mx-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-gray-500">Edit Request</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Edit Your Request</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Update your help request with new information or changes
            </p>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-8">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-yellow-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.954-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <div>
                    <h3 class="font-semibold text-yellow-900 mb-1">Important Notice</h3>
                    <p class="text-yellow-800 text-sm">Editing your request will notify all interested community members about the changes. Make sure your updates are clear and helpful.</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
            <form id="edit-request-form" method="POST" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <div class="space-y-2">
                    <label for="title" class="block text-sm font-semibold text-gray-900">
                        Request Title <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" maxlength="100" required value="{{ request.title }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors"
                           placeholder="Brief, clear title for your request">
                    <p class="text-sm text-gray-600">Be specific but concise (e.g., "Help moving furniture" instead of "Need help")</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="category" class="block text-sm font-semibold text-gray-900">
                            Category <span class="text-red-500">*</span>
                        </label>
                        <select id="category" name="category" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors">
                            <option value="">Select a category</option>
                            <option value="1" {% if request.category == "Errands" %}selected{% endif %}>Errands & Shopping</option>
                            <option value="2" {% if request.category == "Moving" %}selected{% endif %}>Moving & Transportation</option>
                            <option value="3" {% if request.category == "Pet care" %}selected{% endif %}>Pet Care</option>
                            <option value="4" {% if request.category == "Tech Help" %}selected{% endif %}>Tech Help</option>
                            <option value="5" {% if request.category == "Food and meals" %}selected{% endif %}>Food & Meals</option>
                            <option value="7" {% if request.category == "Childcare" %}selected{% endif %}>Childcare</option>
                            <option value="8" {% if request.category == "Home and garden" %}selected{% endif %}>Home & Garden</option>
                            <option value="9" {% if request.category == "Other" %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label for="location" class="block text-sm font-semibold text-gray-900">
                            Location <span class="text-red-500">*</span>
                        </label>
                        <select id="location" name="location" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors">
                            <option value="">Select your area</option>
                            <option value="1" {% if request.location == "Downtown" %}selected{% endif %}>Downtown</option>
                            <option value="2" {% if request.location == "Riverside District" %}selected{% endif %}>Riverside District</option>
                            <option value="3" {% if request.location == "Oak Street" %}selected{% endif %}>Oak Street</option>
                            <option value="4" {% if request.location == "Hillside" %}selected{% endif %}>Hillside</option>
                            <option value="5" {% if request.location == "Market Square" %}selected{% endif %}>Market Square</option>
                            <option value="6" {% if request.location == "Westside" %}selected{% endif %}>Westside</option>
                            <option value="7" {% if request.location == "East End" %}selected{% endif %}>East End</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="description" class="block text-sm font-semibold text-gray-900">
                        Description <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" name="description" rows="4" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors resize-y"
                              placeholder="Describe what you need help with, when, and any important details...">{{ request.description }}</textarea>
                    <p class="text-sm text-gray-600">Include specific details like timing, duration, skills needed, or items involved</p>
                </div>

                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-900">
                        Urgency Level <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="relative">
                            <input type="radio" name="urgency" value="low" required class="sr-only peer" {% if request.urgency_level == "low" %}checked{% endif %}>
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-900">Low</div>
                                    <div class="text-sm text-gray-600">Can wait a few days</div>
                                </div>
                            </div>
                        </label>

                        <label class="relative">
                            <input type="radio" name="urgency" value="medium" required class="sr-only peer" {% if request.urgency_level == "medium" %}checked{% endif %}>
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-yellow-500 peer-checked:bg-yellow-50 hover:border-yellow-300">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-900">Medium</div>
                                    <div class="text-sm text-gray-600">Needed within 1-2 days</div>
                                </div>
                            </div>
                        </label>

                        <label class="relative">
                            <input type="radio" name="urgency" value="high" required class="sr-only peer" {% if request.urgency_level == "high" %}checked{% endif %}>
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-red-500 peer-checked:bg-red-50 hover:border-red-300">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-900">High</div>
                                    <div class="text-sm text-gray-600">Urgent, needed today</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="preferred-time" class="block text-sm font-semibold text-gray-900">Preferred Time</label>
                        <input type="text" id="preferred-time" name="preferred-time" value="{{ request.preferred_time }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors"
                               placeholder="e.g., Weekday evenings, Saturday morning">
                        <p class="text-sm text-gray-600">When would be best for you?</p>
                    </div>

                    <div class="space-y-2">
                        <label for="duration" class="block text-sm font-semibold text-gray-900">Estimated Duration</label>
                        <select id="duration" name="duration"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors">
                            <option value="">Select duration</option>
                            <option value="30min" {% if request.estimated_duration == "30min" %}selected{% endif %}>30 minutes</option>
                            <option value="1hour" {% if request.estimated_duration == "1hour" %}selected{% endif %}>1 hour</option>
                            <option value="2hours" {% if request.estimated_duration == "2hours" %}selected{% endif %}>2 hours</option>
                            <option value="halfday" {% if request.estimated_duration == "halfday" %}selected{% endif %}>Half day</option>
                            <option value="fullday" {% if request.estimated_duration == "fullday" %}selected{% endif %}>Full day</option>
                            <option value="multiday" {% if request.estimated_duration == "multiday" %}selected{% endif %}>Multiple days</option>
                            <option value="ongoing" {% if request.estimated_duration == "ongoing" %}selected{% endif %}>Ongoing</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="compensation" class="block text-sm font-semibold text-gray-900">Offer (Optional)</label>
                    <input type="text" id="compensation" name="compensation" value="{{ request.offer }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors"
                           placeholder="e.g., Home-baked cookies, $20, Trade for services">
                    <p class="text-sm text-gray-600">What can you offer in return? This could be money, food, services, or just gratitude!</p>
                </div>

                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-900">Photos</label>
                    {% if request.photo %}
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">Current photo:</p>
                            <img src="{{ request.photo.url }}" alt="Current request photo" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-200">
                        </div>
                    {% endif %}
                    
                    <div class="photo-upload border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-400 transition-colors cursor-pointer" id="photo-upload">
                        <input type="file" id="photos" name="photos" accept="image/*" class="hidden">
                        <div class="text-6xl mb-4">ðŸ“·</div>
                        <p class="text-lg font-medium text-gray-900 mb-2">
                            {% if request.photo %}Replace photo{% else %}Click to upload photos{% endif %} or drag and drop
                        </p>
                        <p class="text-sm text-gray-600">Add photos to help people understand your request better</p>
                    </div>
                    <div class="photo-preview" id="photo-preview"></div>
                </div>

                <!-- Status Section -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Request Status</h3>
                    <div class="space-y-3">
                        <label class="relative">
                            <input type="radio" name="status" value="open" class="sr-only peer" {% if request.status == "open" %}checked{% endif %}>
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300 flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                <div>
                                    <div class="font-semibold text-gray-900">Keep Open</div>
                                    <div class="text-sm text-gray-600">Continue accepting help offers</div>
                                </div>
                            </div>
                        </label>

                        <label class="relative">
                            <input type="radio" name="status" value="closed" class="sr-only peer" {% if request.status == "closed" %}checked{% endif %}>
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-red-500 peer-checked:bg-red-50 hover:border-red-300 flex items-center">
                                <div class="w-3 h-3 bg-red-500 rounded-full mr-3"></div>
                                <div>
                                    <div class="font-semibold text-gray-900">Mark as Completed</div>
                                    <div class="text-sm text-gray-600">Close this request - no longer need help</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                    <a href="{% url 'aid:request_detail' request.id %}" 
                       class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors text-center">
                        Cancel
                    </a>
                    <button type="button" onclick="confirmDelete()" 
                            class="px-6 py-3 border border-red-300 text-red-700 font-medium rounded-lg hover:bg-red-50 transition-colors">
                        Delete Request
                    </button>
                    <button type="submit" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-blue-700 btn-hover transition-all duration-300">
                        Update Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-auto">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete Request</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this request? This action cannot be undone and will notify all interested community members.</p>
            <div class="flex space-x-3">
                <button onclick="hideDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <form method="POST" action="{% url 'aid:delete_request' request.id %}" class="flex-1">
                    {% csrf_token %}
                    <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Photo upload functionality
    const photoUpload = document.getElementById("photo-upload");
    const photoInput = document.getElementById("photos");
    const photoPreview = document.getElementById("photo-preview");

    photoUpload.addEventListener("click", () => photoInput.click());

    photoUpload.addEventListener("dragover", (e) => {
        e.preventDefault();
        photoUpload.classList.add("border-purple-400", "bg-purple-50");
    });

    photoUpload.addEventListener("dragleave", () => {
        photoUpload.classList.remove("border-purple-400", "bg-purple-50");
    });

    photoUpload.addEventListener("drop", (e) => {
        e.preventDefault();
        photoUpload.classList.remove("border-purple-400", "bg-purple-50");
        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    photoInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        photoPreview.innerHTML = "";
        Array.from(files).forEach((file) => {
            if (file.type.startsWith("image/")) {
                const div = document.createElement("div");
                div.className = "relative group mt-4";
                
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "w-32 h-32 object-cover rounded-lg border-2 border-gray-200";
                img.onload = () => URL.revokeObjectURL(img.src);
                
                const removeBtn = document.createElement("button");
                removeBtn.innerHTML = "Ã—";
                removeBtn.className = "absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity";
                removeBtn.onclick = () => div.remove();
                
                div.appendChild(img);
                div.appendChild(removeBtn);
                photoPreview.appendChild(div);
            }
        });
    }

    // Delete modal functionality
    function confirmDelete() {
        document.getElementById('delete-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function hideDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Form validation
    document.getElementById('edit-request-form').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        
        if (title.length < 10) {
            e.preventDefault();
            alert('Please provide a more descriptive title (at least 10 characters).');
            return;
        }

        if (description.length < 20) {
            e.preventDefault();
            alert('Please provide more details in the description (at least 20 characters).');
            return;
        }
    });

    // Auto-resize textarea
    const textarea = document.getElementById("description");
    textarea.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
    });
</script>
{% endblock %}