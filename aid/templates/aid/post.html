{% extends "aid/base.html" %}
{% load static %}

{% block title %}Post Request - RequestHub{% endblock %}

{% block content %}
<main class="py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Post a Help Request</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Share what you need help with and connect with neighbors willing to assist
            </p>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-8">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-semibold text-blue-900 mb-1">Privacy Notice</h3>
                    <p class="text-blue-800 text-sm">Your request will be visible to all registered community members. Only share information you're comfortable making public.</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
            <form id="request-form" method="POST" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <div class="space-y-2">
                    <label for="title" class="block text-sm font-semibold text-gray-900">
                        Request Title <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" maxlength="100" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors"
                           placeholder="Brief, clear title for your request">
                    <p class="text-sm text-gray-600">Be specific but concise (e.g., "Help moving furniture" instead of "Need help")</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="category" class="block text-sm font-semibold text-gray-900">
                            Category <span class="text-red-500">*</span>
                        </label>
                        <select id="category" name="category" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors">
                            <option value="">Select a category</option>
                            <option value="1">Errands & Shopping</option>
                            <option value="2">Moving & Transportation</option>
                            <option value="3">Pet Care</option>
                            <option value="4">Tech Help</option>
                            <option value="5">Food & Meals</option>
                            <option value="7">Childcare</option>
                            <option value="8">Home & Garden</option>
                            <option value="9">Other</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label for="location" class="block text-sm font-semibold text-gray-900">
                            Location <span class="text-red-500">*</span>
                        </label>
                        <select id="location" name="location" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors">
                            <option value="">Select your area</option>
                            <option value="1">Downtown</option>
                            <option value="2">Riverside District</option>
                            <option value="3">Oak Street</option>
                            <option value="4">Hillside</option>
                            <option value="5">Market Square</option>
                            <option value="6">Westside</option>
                            <option value="7">East End</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="description" class="block text-sm font-semibold text-gray-900">
                        Description <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" name="description" rows="4" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors resize-y"
                              placeholder="Describe what you need help with, when, and any important details..."></textarea>
                    <p class="text-sm text-gray-600">Include specific details like timing, duration, skills needed, or items involved</p>
                </div>

                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-900">
                        Urgency Level <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="relative">
                            <input type="radio" name="urgency" value="low" required class="sr-only peer">
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-900">Low</div>
                                    <div class="text-sm text-gray-600">Can wait a few days</div>
                                </div>
                            </div>
                        </label>

                        <label class="relative">
                            <input type="radio" name="urgency" value="medium" required class="sr-only peer">
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-yellow-500 peer-checked:bg-yellow-50 hover:border-yellow-300">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-900">Medium</div>
                                    <div class="text-sm text-gray-600">Needed within 1-2 days</div>
                                </div>
                            </div>
                        </label>

                        <label class="relative">
                            <input type="radio" name="urgency" value="high" required class="sr-only peer">
                            <div class="p-4 border-2 border-gray-200 rounded-xl cursor-pointer transition-all peer-checked:border-red-500 peer-checked:bg-red-50 hover:border-red-300">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-900">High</div>
                                    <div class="text-sm text-gray-600">Urgent, needed today</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="preferred-time" class="block text-sm font-semibold text-gray-900">Preferred Time</label>
                        <input type="text" id="preferred-time" name="preferred-time"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors"
                               placeholder="e.g., Weekday evenings, Saturday morning">
                        <p class="text-sm text-gray-600">When would be best for you?</p>
                    </div>

                    <div class="space-y-2">
                        <label for="duration" class="block text-sm font-semibold text-gray-900">Estimated Duration</label>
                        <select id="duration" name="duration"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors">
                            <option value="">Select duration</option>
                            <option value="30min">30 minutes</option>
                            <option value="1hour">1 hour</option>
                            <option value="2hours">2 hours</option>
                            <option value="halfday">Half day</option>
                            <option value="fullday">Full day</option>
                            <option value="multiday">Multiple days</option>
                            <option value="ongoing">Ongoing</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="compensation" class="block text-sm font-semibold text-gray-900">Offer (Optional)</label>
                    <input type="text" id="compensation" name="compensation"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors"
                           placeholder="e.g., Home-baked cookies, $20, Trade for services">
                    <p class="text-sm text-gray-600">What can you offer in return? This could be money, food, services, or just gratitude!</p>
                </div>

                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-gray-900">Photos (Optional)</label>
                    <div class="photo-upload border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-400 transition-colors cursor-pointer" id="photo-upload">
                        <input type="file" id="photos" name="photos" multiple accept="image/*" class="hidden">
                        <div class="text-6xl mb-4">ðŸ“·</div>
                        <p class="text-lg font-medium text-gray-900 mb-2">Click to upload photos or drag and drop</p>
                        <p class="text-sm text-gray-600">Add photos to help people understand your request better</p>
                    </div>
                    <div class="photo-preview grid grid-cols-2 md:grid-cols-4 gap-4 mt-4" id="photo-preview"></div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                    <button type="button" onclick="window.history.back()" 
                            class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-blue-700 btn-hover transition-all duration-300">
                        Post Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    // Form handling
    const form = document.getElementById("request-form");
    const photoUpload = document.getElementById("photo-upload");
    const photoInput = document.getElementById("photos");
    const photoPreview = document.getElementById("photo-preview");

    // Photo upload functionality
    photoUpload.addEventListener("click", () => photoInput.click());

    photoUpload.addEventListener("dragover", (e) => {
        e.preventDefault();
        photoUpload.classList.add("border-purple-400", "bg-purple-50");
    });

    photoUpload.addEventListener("dragleave", () => {
        photoUpload.classList.remove("border-purple-400", "bg-purple-50");
    });

    photoUpload.addEventListener("drop", (e) => {
        e.preventDefault();
        photoUpload.classList.remove("border-purple-400", "bg-purple-50");
        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    photoInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        photoPreview.innerHTML = "";
        Array.from(files).forEach((file) => {
            if (file.type.startsWith("image/")) {
                const div = document.createElement("div");
                div.className = "relative group";
                
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "w-full h-24 object-cover rounded-lg";
                img.onload = () => URL.revokeObjectURL(img.src);
                
                const removeBtn = document.createElement("button");
                removeBtn.innerHTML = "Ã—";
                removeBtn.className = "absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity";
                removeBtn.onclick = () => div.remove();
                
                div.appendChild(img);
                div.appendChild(removeBtn);
                photoPreview.appendChild(div);
            }
        });
    }

    // Character count for title
    const titleInput = document.getElementById("title");
    titleInput.addEventListener("input", () => {
        const maxLength = 100;
        const currentLength = titleInput.value.length;
        const remaining = maxLength - currentLength;

        let helpText = titleInput.nextElementSibling;
        if (remaining < 20) {
            helpText.textContent = `${remaining} characters remaining`;
            helpText.className = remaining < 5 ? "text-sm text-red-600" : "text-sm text-yellow-600";
        } else {
            helpText.textContent = 'Be specific but concise (e.g., "Help moving furniture" instead of "Need help")';
            helpText.className = "text-sm text-gray-600";
        }
    });

    // Auto-resize textarea
    const textarea = document.getElementById("description");
    textarea.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
    });

    // Save draft functionality
    function saveDraft() {
        const formData = new FormData(form);
        const draft = Object.fromEntries(formData.entries());
        localStorage.setItem("requesthub_draft", JSON.stringify(draft));
    }

    function loadDraft() {
        const draft = localStorage.getItem("requesthub_draft");
        if (draft) {
            const data = JSON.parse(draft);
            Object.keys(data).forEach((key) => {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === "radio") {
                        const radio = form.querySelector(`[name="${key}"][value="${data[key]}"]`);
                        if (radio) radio.checked = true;
                    } else {
                        field.value = data[key];
                    }
                }
            });
        }
    }

    // Auto-save draft every 30 seconds
    setInterval(saveDraft, 30000);

    // Save draft on input
    form.addEventListener("input", saveDraft);

    // Load draft on page load
    window.addEventListener("load", loadDraft);

    // Form validation and submission
    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Basic validation
        if (!data.title || !data.category || !data.location || !data.description || !data.urgency) {
            alert("Please fill in all required fields.");
            return;
        }

        if (data.title.length < 10) {
            alert("Please provide a more descriptive title (at least 10 characters).");
            return;
        }

        if (data.description.length < 20) {
            alert("Please provide more details in the description (at least 20 characters).");
            return;
        }

        // Submit the form
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;

        submitButton.disabled = true;
        submitButton.textContent = "Posting...";
        submitButton.classList.add("opacity-75");

        // Clear draft on successful submission
        localStorage.removeItem("requesthub_draft");

        // Actually submit the form
        form.submit();
    });

    // Warn about unsaved changes
    let formChanged = false;
    form.addEventListener("input", () => (formChanged = true));

    window.addEventListener("beforeunload", (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = "";
        }
    });
</script>
{% endblock %}