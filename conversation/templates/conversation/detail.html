{% extends 'aid/base.html' %}

{% block title %}Conversation{% endblock %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 80vh;
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow: hidden;
        background: #f9fafb;
    }

    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .together {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
    }

    /* Reverse order for self messages */
    .together.self {
        flex-direction: row-reverse;
    }

    .message {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 16px;
        word-wrap: break-word;
    }

    .message.self {
        background: #3b82f6;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.other {
        background: #e5e7eb;
        color: #111827;
        border-bottom-left-radius: 4px;
    }

    .image {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .message-meta {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-top: 0.25rem;
    }

    .chat-input {
        display: flex;
        border-top: 1px solid #ddd;
        padding: 0.75rem;
        background: white;
    }

    .chat-input textarea {
        flex: 1;
        resize: none;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.5rem;
        margin-right: 0.5rem;
        height:45px;
    }

    .chat-input button {
        background: #14b8a6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: background 0.2s;
    }

    .chat-input button:hover {
        background: #0d9488;
    }
</style>

<h1 class="mb-4 text-2xl font-bold">Conversation</h1>

<div class="chat-container">
    <div id="messages" class="messages">
        {% for message in conversation.messages.all %}
            <div class="together {% if message.created_by == request.user %}self{% endif %}">
            <a href="{% url 'user:profile' %}">
                <img src="{% if message.created_by == request.user %}{{sender.profile_picture.url}}{% else %}{{receiver.profile_picture.url}}{% endif%}" alt="no picture" class="image">
            </a>
                <div class="message {% if message.created_by == request.user %}self{% else %}other{% endif %}">
                    <p>{{ message.content }}</p>
                    <p class="message-meta">
                        {{ message.created_by.username }} Â· {{ message.created_at|date:"H:i" }}
                    </p>
                </div>
            </div>
        {% endfor %}
    </div>

    <form method="post" action="." class="chat-input">
        {% csrf_token %}
        {{ form.content }}
        <button type="submit">Send</button>
    </form>
</div>

<script>
    // Auto-scroll to bottom when page loads
    const messagesDiv = document.getElementById("messages");
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
</script>
{% endblock %}
